.PHONY: all clean test raft paxos comparison diagrams deps

# Raft & Paxos Consensus Protocols Subchapter
# Dependencies: TCP (1.3)

all: deps raft paxos comparison diagrams test

deps:
	@echo "ğŸ” Checking dependencies for Raft & Paxos Consensus..."
	@if [ ! -f "../../01-core-internet-networking/1.3-tcp/tcp_handshake.py" ]; then \
		echo "âŒ Missing dependency: TCP (1.3) - run 'make' in 01-core-internet-networking/1.3-tcp first"; \
		exit 1; \
	fi
	@echo "âœ… All dependencies satisfied"

raft:
	@echo "ğŸ—³ï¸ Running Raft consensus simulation..."
	@python3 raft_consensus.py

paxos:
	@echo "ğŸ›ï¸ Running Paxos consensus simulation..."
	@python3 paxos_consensus.py

comparison:
	@echo "âš–ï¸ Running Raft vs Paxos comparison..."
	@python3 consensus_comparison.py

diagrams:
	@echo "ğŸ¨ Generating consensus algorithm diagrams..."
	@python3 render_diagram.py
	@if command -v mmdc >/dev/null 2>&1; then \
		echo "ğŸ“Š Rendering Mermaid diagram..."; \
		mmdc -i consensus_protocols.mmd -o consensus_protocols_mermaid.png; \
	else \
		echo "âš ï¸  Mermaid CLI not found, skipping .mmd rendering"; \
	fi

test:
	@echo "ğŸ§ª Testing Raft & Paxos consensus implementations..."
	@python3 -c "\
import raft_consensus as raft; \
import paxos_consensus as paxos; \
from raft_consensus import RaftCluster, NodeState; \
from paxos_consensus import PaxosCluster, Proposal; \
cluster = raft.RaftCluster(3); \
assert len(cluster.nodes) == 3; \
assert all(node.state == NodeState.FOLLOWER for node in cluster.nodes.values()); \
print('âœ… Raft: cluster initialization tests passed'); \
paxos_cluster = paxos.PaxosCluster(3); \
assert len(paxos_cluster.nodes) == 3; \
assert all(node.active for node in paxos_cluster.nodes.values()); \
print('âœ… Paxos: cluster initialization tests passed'); \
proposal = Proposal(1, 'test_value'); \
assert proposal.proposal_id == 1; \
assert proposal.value == 'test_value'; \
print('âœ… Paxos: proposal structure tests passed'); \
print('ğŸ¯ All Raft & Paxos consensus tests passed!')"

clean:
	@echo "ğŸ§¹ Cleaning up generated files..."
	@rm -f *.png
	@rm -rf __pycache__/
	@echo "âœ… Cleanup completed"

summary:
	@echo ""
	@echo "=== Raft & Paxos Consensus Summary ==="
	@echo "ğŸ“‹ Protocols: Distributed consensus algorithms"
	@echo "ğŸ¯ Purpose: Enable agreement in distributed systems despite failures"
	@echo "ğŸ”§ Features: Leader election, log replication, fault tolerance"
	@echo "âš¡ Performance: Majority consensus, partition tolerance"
	@echo "ğŸŒ Use Cases: Distributed databases, configuration management, coordination"
	@echo ""
