.PHONY: all clean test gossip membership anti-entropy diagrams deps

# Gossip Protocols Subchapter
# Dependencies: UDP (1.4)

all: deps gossip membership anti-entropy diagrams test

deps:
	@echo "ğŸ” Checking dependencies for Gossip Protocols..."
	@if [ ! -f "../../01-core-internet-networking/1.4-udp/udp_client_server.py" ]; then \
		echo "âŒ Missing dependency: UDP (1.4) - run 'make' in 01-core-internet-networking/1.4-udp first"; \
		exit 1; \
	fi
	@echo "âœ… All dependencies satisfied"

gossip:
	@echo "ğŸ“¡ Running gossip protocol simulation..."
	@python3 gossip_protocol.py

membership:
	@echo "ğŸ¤ Running membership manager demonstration..."
	@python3 membership_manager.py

anti-entropy:
	@echo "ğŸ”„ Running anti-entropy mechanisms..."
	@python3 anti_entropy.py

diagrams:
	@echo "ğŸ¨ Generating gossip protocol diagrams..."
	@python3 render_diagram.py
	@if command -v mmdc >/dev/null 2>&1; then \
		echo "ğŸ“Š Rendering Mermaid diagram..."; \
		mmdc -i gossip_protocols.mmd -o gossip_protocols_mermaid.png; \
	else \
		echo "âš ï¸  Mermaid CLI not found, skipping .mmd rendering"; \
	fi

test:
	@echo "ğŸ§ª Testing gossip protocol implementations..."
	@python3 -c "\
import gossip_protocol as gp; \
import membership_manager as mm; \
import anti_entropy as ae; \
from gossip_protocol import GossipNode, NodeState; \
from membership_manager import MembershipManager, Member; \
from anti_entropy import AntiEntropyManager, StateEntry; \
node = gp.GossipNode('test_node', '127.0.0.1', 9000); \
assert node.node_id == 'test_node'; \
assert node.address == '127.0.0.1'; \
assert node.port == 9000; \
assert len(node.members) == 1; \
print('âœ… Gossip: node initialization tests passed'); \
manager = mm.MembershipManager('test_member', '192.168.1.1'); \
assert manager.local_member_id == 'test_member'; \
assert manager.local_address == '192.168.1.1'; \
assert len(manager.members) == 1; \
print('âœ… Membership: manager initialization tests passed'); \
entropy = ae.AntiEntropyManager('test_entropy'); \
assert entropy.node_id == 'test_entropy'; \
entropy.put('test_key', 'test_value'); \
assert entropy.get('test_key') == 'test_value'; \
print('âœ… Anti-entropy: state management tests passed'); \
print('ğŸ¯ All gossip protocol tests passed!')"

clean:
	@echo "ğŸ§¹ Cleaning up generated files..."
	@rm -f *.png
	@rm -rf __pycache__/
	@echo "âœ… Cleanup completed"

summary:
	@echo ""
	@echo "=== Gossip Protocols Summary ==="
	@echo "ğŸ“‹ Protocols: Epidemic information dissemination"
	@echo "ğŸ¯ Purpose: Decentralized membership and state management"
	@echo "ğŸ”§ Features: SWIM failure detection, anti-entropy, eventual consistency"
	@echo "âš¡ Performance: O(log N) convergence, partition tolerance"
	@echo "ğŸŒ Use Cases: Service discovery, cluster membership, distributed caching"
	@echo ""
